<!-- Full updated index.html for PI system -->
<!-- Will include fields: CRM, Priority, ShadeRef, LotNo, DeliveryDate, ContactNo -->
<!-- Item fields: Color, GSM, DIA, Qty, Rate -->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Proforma Invoice Generator</title>
<style>
  body{margin:0;background:#f6f8fa;font-family:Inter,Arial;}
  .wrap{max-width:850px;margin:20px auto;padding:15px;}
  .card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);margin-top:16px;}
  h2{margin:0 0 10px;font-size:20px;}
  label{font-size:13px;color:#555;font-weight:600;display:block;margin-top:10px;}
  input,select{width:100%;padding:10px;font-size:14px;border-radius:8px;border:1px solid #e0e0e0;margin-top:5px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px;}
  th{background:#f1f5f9;text-align:left;font-weight:600;}
  .btn{background:#2563eb;color:white;padding:12px 18px;border:none;border-radius:10px;margin-top:12px;cursor:pointer;font-size:15px;font-weight:600;}
  .btn.red{background:#dc2626;}
  .row{display:flex;gap:10px;}
  .col{flex:1;}
</style>
</head>
<body>
<div class="wrap">
  <h2>Proforma Invoice Generator</h2>

  <div class="card" id="partyCard">
    <h3>Party Details</h3>
    <label>Select Party</label>
    <select id="partySelect"></select>

    <label>Contact Number</label>
    <input id="contactNumber" placeholder="Enter mobile number">
  </div>

  <div class="card">
    <h3>PI Details</h3>
    <label>CRM</label>
    <input id="crm">

    <label>Priority</label>
    <input id="priority">

    <label>Shade Reference</label>
    <input id="shadeRef">

    <label>Lot Number</label>
    <input id="lotNo">

    <label>Delivery Date</label>
    <input type="date" id="deliveryDate">

    <label>Payment Terms</label>
    <input id="paymentTerms">

    <label>Notes</label>
    <input id="notes">
  </div>

  <div class="card">
    <h3>Add Items</h3>

    <div class="row">
      <div class="col">
        <label>Item</label>
        <select id="itemSelect"></select>
      </div>
      <div class="col">
        <label>Color</label>
        <select id="itemColor"></select>
      </div>
      <div class="col">
        <label>GSM</label>
        <select id="itemGSM"></select>
      </div>
      <div class="col">
        <label>DIA</label>
        <select id="itemDIA"></select>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Qty</label>
        <input id="itemQty" type="number" step="0.01">
      </div>
      <div class="col">
        <label>Rate</label>
        <input id="itemRate" type="number" step="0.01">
      </div>
    </div>

    <button class="btn" onclick="addItem()">Add Item</button>

    <table id="itemsTable">
      <thead>
        <tr>
          <th>Item</th><th>Color</th><th>GSM</th><th>DIA</th><th>Qty</th><th>Rate</th><th>Amount</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn" onclick="generatePI()">Generate PI</button>
</div>

<script>
let MASTER = {};
let ITEMS = [];

async function loadMasters(){
  const url = "https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=masters";
  const r = await fetch(url);
  MASTER = await r.json();

  let pSel = document.getElementById("partySelect");
  MASTER.parties.forEach(p=>{
    let opt = document.createElement("option");
    opt.value = p.PartyID;
    opt.textContent = p.PartyName;
    pSel.appendChild(opt);
  });

  let iSel = document.getElementById("itemSelect");
  MASTER.items.forEach(it=>{
    let o=document.createElement("option");
    o.value=it.ItemID; o.textContent=it.ItemName;
    iSel.appendChild(o);
  });

  fillDropdown("itemColor", MASTER.items.map(i=>i.Color).filter(x=>x));
  fillDropdown("itemGSM", MASTER.items.map(i=>i.GSM).filter(x=>x));
  fillDropdown("itemDIA", MASTER.items.map(i=>i.DIA).filter(x=>x));
}

function fillDropdown(id, arr){
  let setArr = [...new Set(arr)];
  let sel = document.getElementById(id);
  setArr.forEach(v=>{
    let o=document.createElement("option"); o.value=v; o.textContent=v;
    sel.appendChild(o);
  });
}

function addItem(){
  let itemID = document.getElementById("itemSelect").value;
  let it = MASTER.items.find(x=>x.ItemID==itemID);

  let color=document.getElementById("itemColor").value;
  let gsm=document.getElementById("itemGSM").value;
  let dia=document.getElementById("itemDIA").value;
  let qty=parseFloat(document.getElementById("itemQty").value||0);
  let rate=parseFloat(document.getElementById("itemRate").value||it.Rate||0);
  let amount=qty*rate;

  ITEMS.push({ItemID:itemID,ItemName:it.ItemName,Color:color,GSM:gsm,DIA:dia,Qty:qty,Rate:rate,Amount:amount});
  renderItems();
}

function renderItems(){
  let tbody=document.querySelector("#itemsTable tbody");
  tbody.innerHTML="";
  ITEMS.forEach((r,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.ItemName}</td>
      <td>${r.Color}</td>
      <td>${r.GSM}</td>
      <td>${r.DIA}</td>
      <td>${r.Qty}</td>
      <td>${r.Rate}</td>
      <td>${r.Amount.toFixed(2)}</td>
      <td><button class='btn red' onclick='delItem(${i})'>X</button></td>`;
    tbody.appendChild(tr);
  });
}

function delItem(i){ ITEMS.splice(i,1); renderItems(); }

async function generatePI(){
  if(ITEMS.length==0) return alert("Add at least one item");

  let data = {
    partyId: document.getElementById("partySelect").value,
    items: ITEMS,
    extras: {
      contactNumber: document.getElementById("contactNumber").value,
      crm: document.getElementById("crm").value,
      priority: document.getElementById("priority").value,
      shadeRef: document.getElementById("shadeRef").value,
      lotNo: document.getElementById("lotNo").value,
      deliveryDate: document.getElementById("deliveryDate").value,
      paymentTerms: document.getElementById("paymentTerms").value,
      notes: document.getElementById("notes").value
    }
  };

  let url = "https://script.google.com/macros/s/AKfycbxJgQOV2Ip19EpFJltnOAFaaGD1GX2iPub850ie0H4_fAF5fL35nFBcXuCC9-f0q5Lnxw/exec?action=generate&data="+encodeURIComponent(JSON.stringify(data));
  let r = await fetch(url);
  let res = await r.json();

  if(res.ok){
    window.open(res.pdfUrl); 
  } else alert(res.error);
}

loadMasters();
</script>
</body>
</html>
